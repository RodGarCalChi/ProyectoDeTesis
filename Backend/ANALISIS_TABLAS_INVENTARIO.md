# üìä An√°lisis de Tablas: Inventario y Recepci√≥n

## üéØ Objetivo del An√°lisis

Identificar qu√© tablas:
1. ‚úÖ **Mantener**: Son necesarias para el flujo actual
2. ‚ùå **Eliminar**: No se usan o son redundantes
3. ‚ûï **Agregar**: Faltan para completar el flujo

---

## üìã Tablas Actuales en el Sistema

### ‚úÖ TABLAS ESENCIALES (Mantener)

#### 1. **Gesti√≥n de Usuarios**
- `usuarios` - Tabla base de usuarios
- `directores_tecnicos` - Herencia de usuarios
- `transportistas` - Herencia de usuarios (si se usa para despacho)

**Raz√≥n**: Necesarias para autenticaci√≥n y roles.

#### 2. **Gesti√≥n de Clientes**
- `clientes` - Informaci√≥n de clientes
- ~~`cliente_productos`~~ - **EVALUAR** (ver m√°s abajo)

**Raz√≥n**: Los clientes son due√±os de la mercader√≠a.

#### 3. **Cat√°logo de Productos**
- `productos` - Cat√°logo de productos
- `lotes` - Informaci√≥n de lotes

**Raz√≥n**: Necesarias para registrar qu√© productos llegan.

#### 4. **Proceso de Recepci√≥n** ‚≠ê CORE
- `recepciones_mercaderia` - Registro de recepciones
- `detalles_recepcion` - Productos recibidos por recepci√≥n

**Raz√≥n**: N√∫cleo del proceso de recepci√≥n.

#### 5. **Inventario** ‚≠ê CORE
- `inventarios` - Stock actual de productos
- `movimientos_stock` - Historial de movimientos

**Raz√≥n**: Registro de productos en almac√©n.

#### 6. **Almacenamiento**
- `almacenes` - Informaci√≥n de almacenes
- `ubicaciones` - Ubicaciones f√≠sicas en almac√©n
- `zonas` - Zonas dentro del almac√©n

**Raz√≥n**: Necesarias para asignar ubicaciones f√≠sicas.

---

### ‚ùå TABLAS A ELIMINAR (No necesarias actualmente)

#### 1. **`proveedores`** ‚ùå
**Raz√≥n para eliminar**:
- Ya no se usa (cambiamos a `clientes`)
- Redundante con el nuevo flujo
- Puede causar confusi√≥n

**Acci√≥n**: 
```sql
DROP TABLE IF EXISTS proveedores;
```

#### 2. **`detalles_acta_recepcion`** ‚ùå
**Raz√≥n para eliminar**:
- Duplica funcionalidad de `detalles_recepcion`
- No se usa en el flujo actual
- Genera confusi√≥n

**Acci√≥n**:
```sql
DROP TABLE IF EXISTS detalles_acta_recepcion;
```

#### 3. **`registro_almacenamiento`** ‚ùå
**Raz√≥n para eliminar**:
- Funcionalidad cubierta por `inventarios` + `movimientos_stock`
- Redundante
- Complica el modelo

**Acci√≥n**:
```sql
DROP TABLE IF EXISTS registro_almacenamiento;
```

#### 4. **`detalle_almacenamiento`** ‚ùå
**Raz√≥n para eliminar**:
- Relacionada con `registro_almacenamiento`
- No se usa en el flujo actual

**Acci√≥n**:
```sql
DROP TABLE IF EXISTS detalle_almacenamiento;
```

#### 5. **`liberaciones_lote`** ‚ùå (Por ahora)
**Raz√≥n para eliminar**:
- Funcionalidad avanzada no implementada a√∫n
- Se puede agregar despu√©s si es necesario

**Acci√≥n**:
```sql
DROP TABLE IF EXISTS liberaciones_lote;
```

#### 6. **`pedidos`** ‚ùå (Por ahora)
**Raz√≥n para eliminar**:
- No se usa en el flujo de recepci√≥n
- Es para otro m√≥dulo (despacho)
- Se puede agregar despu√©s

**Acci√≥n**:
```sql
-- Mantener si ya tienes el m√≥dulo de pedidos
-- Eliminar si no lo usas a√∫n
DROP TABLE IF EXISTS pedidos;
```

#### 7. **`guias_remision_cliente`** ‚ùå (Por ahora)
**Raz√≥n para eliminar**:
- Para despacho, no para recepci√≥n
- Se puede agregar despu√©s

**Acci√≥n**:
```sql
DROP TABLE IF EXISTS guias_remision_cliente;
DROP TABLE IF EXISTS detalles_guia_remision_cliente;
```

#### 8. **`sensores_temperatura`** ‚ùå (Por ahora)
**Raz√≥n para eliminar**:
- Funcionalidad avanzada
- No cr√≠tica para el flujo b√°sico

**Acci√≥n**:
```sql
DROP TABLE IF EXISTS registros_temperatura;
DROP TABLE IF EXISTS sensores_temperatura;
```

#### 9. **`equipos_frio`** ‚ùå (Por ahora)
**Raz√≥n para eliminar**:
- Funcionalidad avanzada
- No cr√≠tica para el flujo b√°sico

**Acci√≥n**:
```sql
DROP TABLE IF EXISTS equipos_frio;
```

---

### ‚ùì TABLAS A EVALUAR

#### 1. **`cliente_productos`** ‚ùì
**Prop√≥sito**: Relacionar clientes con sus productos espec√≠ficos

**Evaluar**:
- ¬øLos clientes tienen productos espec√≠ficos?
- ¬øO cualquier cliente puede tener cualquier producto?

**Recomendaci√≥n**:
- **Mantener** si cada cliente tiene su propio cat√°logo
- **Eliminar** si todos los clientes pueden tener cualquier producto

---

## ‚ûï TABLAS QUE FALTAN (Agregar)

### 1. **`inventario_cliente`** ‚ûï CR√çTICA

**Prop√≥sito**: Registrar el inventario de productos de cada cliente

**Estructura sugerida**:
```sql
CREATE TABLE inventario_cliente (
    id BINARY(16) PRIMARY KEY,
    cliente_id BINARY(16) NOT NULL,
    producto_id BINARY(16) NOT NULL,
    lote_id BINARY(16) NOT NULL,
    recepcion_id BINARY(16) NOT NULL,
    cantidad_disponible INT NOT NULL DEFAULT 0,
    cantidad_reservada INT NOT NULL DEFAULT 0,
    cantidad_despachada INT NOT NULL DEFAULT 0,
    ubicacion_id BINARY(16),
    fecha_ingreso DATETIME NOT NULL,
    fecha_vencimiento DATE NOT NULL,
    estado ENUM('PENDIENTE_UBICACION', 'ALMACENADO', 'RESERVADO', 'DESPACHADO') NOT NULL,
    temperatura_almacenamiento DECIMAL(5,2),
    observaciones VARCHAR(500),
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (cliente_id) REFERENCES clientes(id),
    FOREIGN KEY (producto_id) REFERENCES productos(id),
    FOREIGN KEY (lote_id) REFERENCES lotes(id),
    FOREIGN KEY (recepcion_id) REFERENCES recepciones_mercaderia(id),
    FOREIGN KEY (ubicacion_id) REFERENCES ubicaciones(id),
    INDEX idx_cliente_producto (cliente_id, producto_id),
    INDEX idx_estado (estado),
    INDEX idx_ubicacion (ubicacion_id)
);
```

**Raz√≥n**: 
- Separa el inventario por cliente
- Permite rastrear productos de cada cliente
- Facilita el despacho por cliente

### 2. **`historial_ubicaciones`** ‚ûï RECOMENDADA

**Prop√≥sito**: Auditor√≠a de cambios de ubicaci√≥n

**Estructura sugerida**:
```sql
CREATE TABLE historial_ubicaciones (
    id BINARY(16) PRIMARY KEY,
    inventario_cliente_id BINARY(16) NOT NULL,
    ubicacion_anterior_id BINARY(16),
    ubicacion_nueva_id BINARY(16) NOT NULL,
    motivo VARCHAR(200),
    usuario_id BINARY(16) NOT NULL,
    fecha_movimiento DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (inventario_cliente_id) REFERENCES inventario_cliente(id),
    FOREIGN KEY (ubicacion_anterior_id) REFERENCES ubicaciones(id),
    FOREIGN KEY (ubicacion_nueva_id) REFERENCES ubicaciones(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);
```

**Raz√≥n**:
- Trazabilidad de movimientos
- Auditor√≠a completa
- √ötil para resolver problemas

---

## üîÑ Flujo de Datos con las Nuevas Tablas

### FASE 1: Recepci√≥n registra productos
```
recepciones_mercaderia (PENDIENTE)
    ‚Üì
detalles_recepcion (productos agregados)
    ‚Üì
recepciones_mercaderia (EN_CUARENTENA)
```

### FASE 2: Administrativa valida y registra
```
recepciones_mercaderia (EN_CUARENTENA)
    ‚Üì (valida)
recepciones_mercaderia (APROBADO)
    ‚Üì (registra productos conformes)
inventario_cliente (PENDIENTE_UBICACION)
    ‚Üì
lotes (actualiza o crea)
```

### FASE 3: Operaciones asigna ubicaci√≥n
```
inventario_cliente (PENDIENTE_UBICACION)
    ‚Üì (asigna ubicacion_id)
inventario_cliente (ALMACENADO)
    ‚Üì
historial_ubicaciones (registro del movimiento)
```

---

## üìä Modelo de Datos Simplificado

### Tablas Core del Flujo:

```
clientes
    ‚Üì
recepciones_mercaderia
    ‚Üì
detalles_recepcion
    ‚Üì (aprobaci√≥n)
inventario_cliente ‚Üê productos + lotes
    ‚Üì (asignaci√≥n)
ubicaciones
```

---

## üéØ Recomendaciones Finales

### Eliminar AHORA (Simplificar):
1. ‚ùå `proveedores`
2. ‚ùå `detalles_acta_recepcion`
3. ‚ùå `registro_almacenamiento`
4. ‚ùå `detalle_almacenamiento`
5. ‚ùå `liberaciones_lote`
6. ‚ùå `sensores_temperatura`
7. ‚ùå `registros_temperatura`
8. ‚ùå `equipos_frio`

### Eliminar SI NO SE USAN (Evaluar):
9. ‚ùì `pedidos` (si no tienes m√≥dulo de pedidos)
10. ‚ùì `guias_remision_cliente` (si no tienes m√≥dulo de despacho)
11. ‚ùì `detalles_guia_remision_cliente`
12. ‚ùì `cliente_productos` (si no necesitas cat√°logo por cliente)

### Agregar AHORA (Cr√≠ticas):
1. ‚ûï `inventario_cliente` - **CR√çTICA**
2. ‚ûï `historial_ubicaciones` - **RECOMENDADA**

### Mantener (Esenciales):
- ‚úÖ `usuarios` y herencias
- ‚úÖ `clientes`
- ‚úÖ `productos`
- ‚úÖ `lotes`
- ‚úÖ `recepciones_mercaderia`
- ‚úÖ `detalles_recepcion`
- ‚úÖ `inventarios` (si la usas para stock general)
- ‚úÖ `movimientos_stock`
- ‚úÖ `almacenes`
- ‚úÖ `ubicaciones`
- ‚úÖ `zonas`

---

## üìù Script de Migraci√≥n Sugerido

```sql
-- ============================================
-- PASO 1: ELIMINAR TABLAS INNECESARIAS
-- ============================================

-- Eliminar tablas relacionadas con proveedores
DROP TABLE IF EXISTS proveedores;

-- Eliminar duplicados de acta de recepci√≥n
DROP TABLE IF EXISTS detalles_acta_recepcion;

-- Eliminar tablas de almacenamiento redundantes
DROP TABLE IF EXISTS detalle_almacenamiento;
DROP TABLE IF EXISTS registro_almacenamiento;

-- Eliminar funcionalidades avanzadas no usadas
DROP TABLE IF EXISTS liberaciones_lote;
DROP TABLE IF EXISTS registros_temperatura;
DROP TABLE IF EXISTS sensores_temperatura;
DROP TABLE IF EXISTS equipos_frio;

-- OPCIONAL: Eliminar si no se usan
-- DROP TABLE IF EXISTS detalles_guia_remision_cliente;
-- DROP TABLE IF EXISTS guias_remision_cliente;
-- DROP TABLE IF EXISTS pedidos;

-- ============================================
-- PASO 2: CREAR TABLA DE INVENTARIO POR CLIENTE
-- ============================================

CREATE TABLE inventario_cliente (
    id BINARY(16) PRIMARY KEY,
    cliente_id BINARY(16) NOT NULL,
    producto_id BINARY(16) NOT NULL,
    lote_id BINARY(16) NOT NULL,
    recepcion_id BINARY(16) NOT NULL,
    detalle_recepcion_id BINARY(16),
    cantidad_disponible INT NOT NULL DEFAULT 0,
    cantidad_reservada INT NOT NULL DEFAULT 0,
    cantidad_despachada INT NOT NULL DEFAULT 0,
    ubicacion_id BINARY(16),
    codigo_barras VARCHAR(100),
    fecha_ingreso DATETIME NOT NULL,
    fecha_vencimiento DATE NOT NULL,
    estado ENUM('PENDIENTE_UBICACION', 'ALMACENADO', 'RESERVADO', 'DESPACHADO', 'VENCIDO') NOT NULL DEFAULT 'PENDIENTE_UBICACION',
    temperatura_almacenamiento DECIMAL(5,2),
    observaciones VARCHAR(500),
    usuario_registro_id BINARY(16),
    usuario_ubicacion_id BINARY(16),
    fecha_creacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    fecha_actualizacion DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (cliente_id) REFERENCES clientes(id),
    FOREIGN KEY (producto_id) REFERENCES productos(id),
    FOREIGN KEY (lote_id) REFERENCES lotes(id),
    FOREIGN KEY (recepcion_id) REFERENCES recepciones_mercaderia(id),
    FOREIGN KEY (detalle_recepcion_id) REFERENCES detalles_recepcion(id),
    FOREIGN KEY (ubicacion_id) REFERENCES ubicaciones(id),
    FOREIGN KEY (usuario_registro_id) REFERENCES usuarios(id),
    FOREIGN KEY (usuario_ubicacion_id) REFERENCES usuarios(id),
    
    INDEX idx_cliente_producto (cliente_id, producto_id),
    INDEX idx_estado (estado),
    INDEX idx_ubicacion (ubicacion_id),
    INDEX idx_lote (lote_id),
    INDEX idx_vencimiento (fecha_vencimiento)
);

-- ============================================
-- PASO 3: CREAR TABLA DE HISTORIAL DE UBICACIONES
-- ============================================

CREATE TABLE historial_ubicaciones (
    id BINARY(16) PRIMARY KEY,
    inventario_cliente_id BINARY(16) NOT NULL,
    ubicacion_anterior_id BINARY(16),
    ubicacion_nueva_id BINARY(16) NOT NULL,
    motivo VARCHAR(200),
    usuario_id BINARY(16) NOT NULL,
    fecha_movimiento DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (inventario_cliente_id) REFERENCES inventario_cliente(id) ON DELETE CASCADE,
    FOREIGN KEY (ubicacion_anterior_id) REFERENCES ubicaciones(id),
    FOREIGN KEY (ubicacion_nueva_id) REFERENCES ubicaciones(id),
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id),
    
    INDEX idx_inventario (inventario_cliente_id),
    INDEX idx_fecha (fecha_movimiento)
);

-- ============================================
-- PASO 4: VERIFICACI√ìN
-- ============================================

-- Ver todas las tablas
SHOW TABLES;

-- Ver estructura de la nueva tabla
DESCRIBE inventario_cliente;
DESCRIBE historial_ubicaciones;
```

---

## üéì Explicaci√≥n del Modelo

### ¬øPor qu√© `inventario_cliente` en lugar de `inventarios`?

**Tabla actual `inventarios`**:
- Probablemente es stock general
- No separa por cliente
- Dificulta el tracking por cliente

**Nueva tabla `inventario_cliente`**:
- ‚úÖ Separa inventario por cliente
- ‚úÖ Cada cliente ve solo sus productos
- ‚úÖ Facilita facturaci√≥n por cliente
- ‚úÖ Mejor trazabilidad
- ‚úÖ Permite diferentes precios por cliente

### Estados del Inventario:

1. **PENDIENTE_UBICACION**: Aprobado por administrativa, sin ubicaci√≥n
2. **ALMACENADO**: Con ubicaci√≥n asignada, disponible
3. **RESERVADO**: Apartado para un pedido
4. **DESPACHADO**: Ya sali√≥ del almac√©n
5. **VENCIDO**: Producto vencido

---

## üìû Pr√≥ximos Pasos

1. **Revisar** este an√°lisis
2. **Decidir** qu√© tablas eliminar
3. **Ejecutar** script de migraci√≥n
4. **Crear** entidades Java para las nuevas tablas
5. **Implementar** endpoints del backend
6. **Probar** el flujo completo

---

## ‚ö†Ô∏è IMPORTANTE

Antes de eliminar tablas:
1. ‚úÖ Hacer BACKUP completo de la base de datos
2. ‚úÖ Verificar que no haya datos importantes
3. ‚úÖ Probar en ambiente de desarrollo primero
4. ‚úÖ Documentar los cambios

```bash
# Backup de la base de datos
mysqldump -u usuario -p BaseDeDatos > backup_antes_limpieza.sql
```
